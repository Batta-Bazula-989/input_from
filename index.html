<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitor Analysis</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 50px;
            border-radius: 20px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            color: #1a202c;
            text-align: center;
            letter-spacing: -0.5px;
        }

        .competitors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        input[type="text"] {
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
            color: #1a202c;
            font-weight: 500;
        }

        .security-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.2);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e40af;
        }

        .rate-limit-warning {
            background-color: #fef3c7;
            border: 2px solid #fbbf24;
            color: #92400e;
        }

        .rate-limit-counter {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1e40af;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rate-limit-counter.warning {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.3);
            color: #92400e;
        }

        .rate-limit-counter.danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #dc2626;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow:
                0 0 0 4px rgba(59, 130, 246, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.04);
            transform: translateY(-1px);
        }

        input[type="text"]:hover {
            border-color: #cbd5e0;
        }

        input[type="text"]::placeholder {
            color: #9ca3af;
        }

        .dropdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        select {
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 48px;
            color: #1a202c;
            font-weight: 500;
        }

        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow:
                0 0 0 4px rgba(59, 130, 246, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.04);
            transform: translateY(-1px);
        }

        select option {
            padding: 12px 16px;
            background-color: #ffffff;
            color: #374151;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            box-shadow:
                0 10px 20px rgba(30, 41, 59, 0.2),
                0 4px 8px rgba(30, 41, 59, 0.1);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            transform: translateY(-2px);
            box-shadow:
                0 15px 30px rgba(30, 41, 59, 0.3),
                0 8px 16px rgba(30, 41, 59, 0.15);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #64748b;
            border: 2px solid #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(248, 250, 252, 0.9);
            border-color: #cbd5e0;
            transform: translateY(-1px);
            box-shadow: 0 8px 16px rgba(100, 116, 139, 0.1);
        }

        .message {
            margin-top: 20px;
            padding: 16px;
            border-radius: 12px;
            font-weight: 500;
            display: none;
        }

        .error-message {
            background-color: #fee2e2;
            border: 2px solid #fca5a5;
            color: #dc2626;
        }

        .success-message {
            background-color: #dcfce7;
            border: 2px solid #86efac;
            color: #16a34a;
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
            }

            .competitors-grid {
                grid-template-columns: 1fr;
            }

            .dropdown-grid {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            h1 {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Enter 3 competitors</h1>

    <div class="security-info">
        üîí This form analyzes viral social media content from competitors. Security measures include input validation, rate limiting, and sanitization.
    </div>

    <div id="rateLimitCounter" class="rate-limit-counter">
        <span>‚è±Ô∏è Requests remaining this hour: <strong id="requestsRemaining">20</strong>/20</span>
        <span id="cooldownTimer"></span>
    </div>

    <form id="competitorForm">'
        <div class="competitors-grid">
            <div class="input-group">
                <label for="competitor1">Competitor 1</label>
                <input type="text" id="competitor1" name="competitor1" maxlength="25"
                       pattern="^[a-zA-Z0-9\s\-\.\_]+$"
                       title="Only letters, numbers, spaces, hyphens, dots and underscores allowed">
            </div>

            <div class="input-group">
                <label for="competitor2">Competitor 2</label>
                <input type="text" id="competitor2" name="competitor2" maxlength="25"
                       pattern="^[a-zA-Z0-9\s\-\.\_]+$"
                       title="Only letters, numbers, spaces, hyphens, dots and underscores allowed">
            </div>

            <div class="input-group">
                <label for="competitor3">Competitor 3</label>
                <input type="text" id="competitor3" name="competitor3" maxlength="25"
                       pattern="^[a-zA-Z0-9\s\-\.\_]+$"
                       title="Only letters, numbers, spaces, hyphens, dots and underscores allowed">
            </div>
        </div>

        <div class="dropdown-grid">
            <div class="input-group">
                <label for="country">Country</label>
                <select id="country" name="country">
                    <option value="UA">UA</option>
                    <option value="PL">PL</option>
                    <option value="DE">DE</option>
                    <option value="US">US</option>
                    <option value="GB">GB</option>
                </select>
            </div>

            <div class="input-group">
                <label for="status">Status</label>
                <select id="status" name="status">
                    <option value="active">active</option>
                    <option value="inactive">inactive</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn btn-primary" onclick="runAnalysis()">Run analysis</button>
            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset</button>
        </div>

        <div id="errorMessage" class="message error-message"></div>
        <div id="successMessage" class="message success-message"></div>
    </form>
</div>

<script>
    // Security configuration
    const SECURITY_CONFIG = {
        MAX_REQUESTS_PER_HOUR: 20,
        ALLOWED_CHARS_REGEX: /^[a-zA-Z0-9\s\-\.\_]+$/,
        MIN_REQUEST_INTERVAL: 6000, // 6 seconds between requests
        SESSION_TOKEN: null
    };

    // Generate session token for CSRF protection
    function generateSessionToken() {
        return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
    }

    // Initialize session token
    SECURITY_CONFIG.SESSION_TOKEN = generateSessionToken();

    // Rate limiting functionality
    function checkRateLimit() {
        const now = Date.now();
        const requests = JSON.parse(sessionStorage.getItem('requests') || '[]');

        // Remove requests older than 1 hour
        const recentRequests = requests.filter(time => now - time < 3600000);

        if (recentRequests.length >= SECURITY_CONFIG.MAX_REQUESTS_PER_HOUR) {
            return false;
        }

        // Check minimum interval between requests
        if (recentRequests.length > 0) {
            const lastRequest = Math.max(...recentRequests);
            if (now - lastRequest < SECURITY_CONFIG.MIN_REQUEST_INTERVAL) {
                return false;
            }
        }

        // Add current request
        recentRequests.push(now);
        sessionStorage.setItem('requests', JSON.stringify(recentRequests));

        // Update counter display
        updateRateLimitDisplay();

        return true;
    }

    // Update rate limit counter display
    function updateRateLimitDisplay() {
        const now = Date.now();
        const requests = JSON.parse(sessionStorage.getItem('requests') || '[]');
        const recentRequests = requests.filter(time => now - time < 3600000);

        const remaining = SECURITY_CONFIG.MAX_REQUESTS_PER_HOUR - recentRequests.length;
        const counterElement = document.getElementById('rateLimitCounter');
        const remainingElement = document.getElementById('requestsRemaining');
        const cooldownElement = document.getElementById('cooldownTimer');

        remainingElement.textContent = remaining;

        // Update counter styling based on remaining requests
        counterElement.className = 'rate-limit-counter';
        if (remaining <= 5) {
            counterElement.className += ' danger';
        } else if (remaining <= 10) {
            counterElement.className += ' warning';
        }

        // Show cooldown timer if needed
        if (recentRequests.length > 0) {
            const lastRequest = Math.max(...recentRequests);
            const timeSinceLastRequest = now - lastRequest;
            const cooldownRemaining = SECURITY_CONFIG.MIN_REQUEST_INTERVAL - timeSinceLastRequest;

            if (cooldownRemaining > 0) {
                const seconds = Math.ceil(cooldownRemaining / 1000);
                cooldownElement.textContent = `Next request in: ${seconds}s`;

                // Start countdown timer
                const countdownInterval = setInterval(() => {
                    const newNow = Date.now();
                    const newCooldownRemaining = SECURITY_CONFIG.MIN_REQUEST_INTERVAL - (newNow - lastRequest);

                    if (newCooldownRemaining <= 0) {
                        cooldownElement.textContent = '';
                        clearInterval(countdownInterval);
                    } else {
                        const newSeconds = Math.ceil(newCooldownRemaining / 1000);
                        cooldownElement.textContent = `Next request in: ${newSeconds}s`;
                    }
                }, 1000);
            } else {
                cooldownElement.textContent = '';
            }
        }
    }

    // Input sanitization
    function sanitizeInput(input) {
        if (typeof input !== 'string') return '';

        // First trim whitespace
        input = input.trim();

        // If empty after trimming, return empty
        if (input.length === 0) return '';

        // Remove any HTML/script tags
        input = input.replace(/<[^>]*>?/gm, '');

        // Remove potentially dangerous characters
        input = input.replace(/[<>\"'&]/g, '');

        // Check against allowed characters - if invalid, return empty string
        if (!SECURITY_CONFIG.ALLOWED_CHARS_REGEX.test(input)) {
            console.log('Input failed regex test:', input);
            return '';
        }

        return input;
    }

    // Validate competitor name
    function validateCompetitorName(name) {
        if (!name || name.length === 0) return true; // Empty is allowed
        if (name.length > 25) return false;
        if (!SECURITY_CONFIG.ALLOWED_CHARS_REGEX.test(name)) return false;

        // Additional security checks
        if (name.includes('..') || name.includes('//')) return false; // Path traversal prevention

        return true;
    }

    function runAnalysis() {
        console.log('Run analysis clicked');
        hideMessages();

        // Get competitor values and sanitize them
        let competitor1 = sanitizeInput(document.getElementById('competitor1').value);
        let competitor2 = sanitizeInput(document.getElementById('competitor2').value);
        let competitor3 = sanitizeInput(document.getElementById('competitor3').value);

        console.log('Sanitized values:', competitor1, competitor2, competitor3);

        // Validation - at least one competitor required (check AFTER sanitization)
        if (!competitor1 && !competitor2 && !competitor3) {
            console.log('No valid competitors entered after sanitization');
            showError('Please enter at least one valid competitor/brand name for viral content analysis');
            return;
        }

        // Rate limiting check (moved after input validation)
        if (!checkRateLimit()) {
            showError('Rate limit exceeded. Please wait before making another request (max 20 requests per hour, 6 seconds between requests).', 'rate-limit-warning');
            return;
        }

        // Validate each competitor name (this is now redundant but kept for extra safety)
        if ((competitor1 && !validateCompetitorName(competitor1)) ||
            (competitor2 && !validateCompetitorName(competitor2)) ||
            (competitor3 && !validateCompetitorName(competitor3))) {
            showError('Invalid competitor name detected. Only letters, numbers, spaces, hyphens, dots and underscores are allowed.');
            return;
        }

        // Collect only non-empty competitors
        const competitors = [competitor1, competitor2, competitor3].filter(c => c !== '');

        // Check for competitor name length (max 25 characters)
        const tooLongCompetitors = competitors.filter(c => c.length > 25);
        if (tooLongCompetitors.length > 0) {
            showError('Competitor names must be 25 characters or less');
            return;
        }

        // Check for duplicates among entered competitors (case-insensitive)
        const uniqueCompetitors = [...new Set(competitors.map(c => c.toLowerCase()))];
        if (uniqueCompetitors.length !== competitors.length) {
            showError('Please enter different competitors (no duplicates)');
            return;
        }

        // Validate dropdown selections
        const country = document.getElementById('country').value;
        const status = document.getElementById('status').value;

        const allowedCountries = ['UA', 'PL', 'DE', 'US', 'GB'];
        const allowedStatuses = ['active', 'inactive'];

        if (!allowedCountries.includes(country) || !allowedStatuses.includes(status)) {
            showError('Invalid selection detected');
            return;
        }

        // Collect form data with security headers
        const formData = {
            competitors: competitors,
            country: country,
            status: status,
            sessionToken: SECURITY_CONFIG.SESSION_TOKEN,
            timestamp: Date.now(),
            userAgent: navigator.userAgent.substr(0, 100) // Limit length
        };

        console.log('Secure data to send:', {
            competitors: formData.competitors,
            country: formData.country,
            status: formData.status,
            hasToken: !!formData.sessionToken
        });

        // Replace with your actual webhook URL
        const webhookUrl = 'YOUR_N8N_WEBHOOK_URL_HERE';

        // For testing purposes, just show success without actually sending
        if (webhookUrl === 'YOUR_N8N_WEBHOOK_URL_HERE') {
            showSuccess('‚úÖ Security validation passed. Ready to send data to webhook. Rate limit: 20 requests/hour, 6 seconds between requests.');
            return;
        }

        // Disable submit button to prevent double submission
        const submitBtn = document.querySelector('.btn-primary');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';

        // Send to webhook with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        fetch(webhookUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-Session-Token': SECURITY_CONFIG.SESSION_TOKEN
            },
            body: JSON.stringify(formData),
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (response.ok) {
                showSuccess('Analysis started successfully!');
                // Generate new token for next request
                SECURITY_CONFIG.SESSION_TOKEN = generateSessionToken();
            } else {
                showError('Error starting analysis');
            }
        })
        .catch(error => {
            clearTimeout(timeoutId);
            console.error('Error:', error);
            if (error.name === 'AbortError') {
                showError('Request timeout. Please try again.');
            } else {
                showError('Error connecting to webhook');
            }
        })
        .finally(() => {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    }

    function resetForm() {
        document.getElementById('competitorForm').reset();
        hideMessages();
        // Don't reset rate limiting on form reset
    }

    function showError(message, className = 'error-message') {
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        errorDiv.textContent = message;
        errorDiv.className = `message ${className}`;
        errorDiv.style.display = 'block';
        successDiv.style.display = 'none';
    }

    function showSuccess(message) {
        const errorDiv = document.getElementById('errorMessage');
        const successDiv = document.getElementById('successMessage');
        successDiv.textContent = message;
        successDiv.style.display = 'block';
        errorDiv.style.display = 'none';
    }

    function hideMessages() {
        document.getElementById('errorMessage').style.display = 'none';
        document.getElementById('successMessage').style.display = 'none';
    }

    // Security event listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded with security features enabled');

        // Initialize rate limit display
        updateRateLimitDisplay();

        // Update display every 30 seconds to keep it current
        setInterval(updateRateLimitDisplay, 30000);

        // Prevent form submission via Enter key to force validation
        document.getElementById('competitorForm').addEventListener('submit', function(e) {
            console.log('Form submit triggered');
            e.preventDefault();
            runAnalysis();
        });

        // Real-time input validation
        ['competitor1', 'competitor2', 'competitor3'].forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', function() {
                const value = this.value;
                if (value && !SECURITY_CONFIG.ALLOWED_CHARS_REGEX.test(value)) {
                    this.style.borderColor = '#ef4444';
                    this.title = 'Invalid characters detected';
                } else {
                    this.style.borderColor = '#e2e8f0';
                    this.title = 'Only letters, numbers, spaces, hyphens, dots and underscores allowed';
                }
            });
        });

        // Prevent right-click context menu on form (optional security measure)
        document.getElementById('competitorForm').addEventListener('contextmenu', function(e) {
            e.preventDefault();
        });

        // Clear sensitive data on page unload
        window.addEventListener('beforeunload', function() {
            // Clear any sensitive data if needed
            SECURITY_CONFIG.SESSION_TOKEN = null;
        });
    });

    // Additional security: Detect if form is being automated
    let humanInteraction = false;
    document.addEventListener('mousemove', () => humanInteraction = true, { once: true });
    document.addEventListener('keydown', () => humanInteraction = true, { once: true });
</script>
</body>
</html>